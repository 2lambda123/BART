#ifndef __bart_tools_h__
#define __bart_tools_h__

#include <deal.II/base/parameter_handler.h>
#include <deal.II/base/conditional_ostream.h>
#include <deal.II/fe/fe_poly.h>

#include <string>

#include "../equation/equation_base.h"
#include "../aqdata/aq_base.h"
#include "../mesh/mesh_generator.h"
#include "../iteration/iterations.h"
#include "../iteration/eigen_base.h"
#include "../iteration/mg_base.h"
#include "../iteration/ig_base.h"
#include "../material/material_properties.h"

using namespace dealii;

/** \brief Function to build finite element for general dimensions specified by
 * user.
 *
 * \parameter prm A reference to processed ParameterHandler instance
 * \return A raw pointer of finite elements derived from FE_Poly
 */
template <int dim>
void build_finite_element
(FE_Poly<TensorProductPolynomials<dim>,dim,dim>* fe, ParameterHandler &prm);

/** \brief Function to build mesh in calculations for general dimensions
 *
 * \parameter prm A reference to processed ParameterHandler instance
 * \return A shared pointer to MeshGenerator<dim> instance
 */
template <int dim>
void build_mesh
(std_cxx11::shared_ptr<MeshGenerator<dim> > msh_ptr, ParameterHandler &prm);

/** \brief Function to build pointer to MaterialProperties class.
 *
 * \parameter prm A reference to processed ParameterHandler instance
 * \return A shared pointer to MaterialProperties instance
 */
void build_material
(std_cxx11::shared_ptr<MaterialProperties> mat_ptr, ParameterHandler &prm);

/** \brief Build specific transport model
 *
 * \parameter msh_ptr shared_ptr for MeshGenerator<dim> instance
 * \parameter aqd_ptr shared_ptr for AQBase<dim> instance
 * \parameter mat_ptr shared_ptr for MaterialProperties instance
 * \return a shared pointer to transport model
 */
template <int dim>
void build_equation
(std_cxx11::shared_ptr<EquationBase<dim> > equ_ptr,
 std::string equation_name,
 ParameterHandler &prm,
 const std_cxx11::shared_ptr<MeshGenerator<dim> > msh_ptr,
 const std_cxx11::shared_ptr<AQBase<dim> > aqd_ptr,
 const std_cxx11::shared_ptr<MaterialProperties> mat_ptr);

/** \brief Build linear algebraic related stuffs for solving linear equations
 */
void build_linalg
(std_cxx11::shared_ptr<PreconditionerSolver> alg_ptr,
 ParameterHandler &prm,
 std::string equation_name,
 unsigned int& n_total_vars);

/** \brief Build iterations to solve the transport problem with iterative methods
 *
 * This specific iteration classes according to method type will be further detailed
 * inside Iteration<dim>::solve_problem. This class is designed as a buffer between
 * BartDriver and specific iterative methods s.t. BartDriver will only "drive"
 * without knowing what iterative methods are involved.
 */
template <int dim>
void build_iterations
(std_cxx11::shared_ptr<Iterations<dim> > itr_ptr,
 const ParameterHandler &prm,
 const std_cxx11::shared_ptr<MeshGenerator<dim> > msh_ptr,
 const std_cxx11::shared_ptr<AQBase<dim> > aqd_ptr,
 const std_cxx11::shared_ptr<MaterialProperties> mat_ptr);

template <int dim>
void build_eigen_iterations
(std_cxx11::shared_ptr<EigenBase<dim> > eig_ptr, ParameterHandler &prm);

template <int dim>
void build_mg_iterations
(std_cxx11::shared_ptr<MGBase<dim> > mg_ptr, ParameterHandler &prm);

template <int dim>
std_cxx11::shared_ptr<IGBase<dim> > build_ig_iterations
(ParameterHandler &prm);


/** \brief Function to build angular quadrature for general dimensions
 *
 * \parameter prm A processed ParameterHandler instance
 * \return a shared pointer to specific angular quadrature
 */
template <int dim>
void build_aq_model
(std_cxx11::shared_ptr<AQBase<dim> >aq_pointer, ParameterHandler &prm);

/** \brief ConditionalOStream object used to output things on screen with processor 0
 */
ConditionalOStream pout
(std::cout, Utilities::MPI::this_mpi_process(MPI_COMM_WORLD)==0);

#endif //__bart_tools_h__
